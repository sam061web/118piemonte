<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibilit√† al soccorso sanitario in Piemonte</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #333; 
        }

        /* --- CONTENITORE MAPPA --- */
        .map-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
        }

        iframe {
            position: absolute;
            border: none;
            width: 100%;
            height: calc(100% + 64px + 40px); 
            top: -64px; 
            left: 0;
        }

        /* --- BOX TITOLO + LEGENDA --- */
        .info-panel {
            position: absolute;
            top: 100px; 
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 10;
            max-width: 480px; 
        }
        
        .info-panel h1 {
            font-size: 1.1rem;
            color: #2c3e50;
            margin: 0 0 10px 0; 
            font-weight: 700;
            line-height: 1.3;
        }

        /* Legenda Orizzontale */
        .legend-grid {
            display: flex;
            flex-direction: row; 
            flex-wrap: wrap;     
            gap: 15px;           
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* --- COLORI DEFINITIVI --- */
        .color-1 { background-color: #CE1256; } /* 5-10 min */
        .color-2 { background-color: #DF65B0; } /* 10-15 min */
        .color-3 { background-color: #D7B5D8; } /* 15-20 min */
        .color-4 { background-color: #F1EEF6; border: 1px solid #ccc; } /* Oltre 20 min (bordo aggiunto per visibilit√†) */

        /* --- PULSANTI LATERALI (Info e Stats) --- */
        .round-btn {
            position: absolute;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: white;
            color: #2c3e50;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: transform 0.2s, background-color 0.2s;
        }

        .round-btn:hover {
            transform: scale(1.1);
            background-color: #f8f9fa;
        }

        /* Posizioni specifiche */
        .btn-info { top: 20px; }
        .btn-stats { top: 70px; } /* Subito sotto */

        /* --- PULSANTE FANTASMA (LAYER) - Basso a Destra --- */
        .ghost-button-wrapper {
            position: absolute;
            bottom: 35px; 
            right: 20px; 
            width: 48px;  
            height: 48px; 
            z-index: 100;
            pointer-events: none; 
            background-color: #e74c3c;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .map-icon {
            width: 24px; 
            height: 24px;
            fill: white;
        }

        /* --- POPUP (MODALE) GLOBALE --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); 
            z-index: 2000; 
            display: none; 
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(3px);
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 600px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
            text-align: center;
            position: relative;
            max-height: 90vh;
            overflow-y: auto; /* Scroll se il contenuto √® lungo */
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .modal-content h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .modal-content p {
            color: #444;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95rem;
            text-align: left;
        }

        /* Stile specifico per la lista statistiche */
        .stats-list {
            list-style: none;
            text-align: left;
            margin-top: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .stats-list li {
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .credits-list {
            text-align: left;
            font-size: 0.9rem;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .credits-list strong { color: #333; }

        .close-btn {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 1rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            margin-top: 15px;
        }

        .close-btn:hover { background-color: #1a252f; }
        .btn-start { background-color: #e74c3c; }
        .btn-start:hover { background-color: #c0392b; }

        /* Contenitore Grafico */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            .info-panel {
                top: 80px; 
                left: 10px;
                right: 10px;
                max-width: none;
            }
            .ghost-button-wrapper {
                bottom: 30px; 
                right: 15px;
            }
        }
    </style>
</head>
<body>

    <div class="map-wrapper">
        <iframe src="https://pinea.app.carto.com/map/98249c1d-84dd-4448-b163-d7e89c40455b" title="Mappa CARTO"></iframe>
    </div>

    <div class="info-panel">
        <h1>Accessibilit√† al soccorso sanitario in Piemonte</h1>
        
        <div class="legend-grid">
            <div class="legend-item"><span class="dot color-1"></span> 5-10 minuti</div>
            <div class="legend-item"><span class="dot color-2"></span> 10-15 minuti</div>
            <div class="legend-item"><span class="dot color-3"></span> 15-20 minuti</div>
            <div class="legend-item"><span class="dot color-4"></span> Oltre 20 minuti</div>
        </div>
    </div>

    <button class="round-btn btn-info" onclick="openModal('creditsModal')" title="Credits">
        <i class="fas fa-info"></i>
    </button>
    
    <button class="round-btn btn-stats" onclick="openModal('statsModal')" title="Statistiche">
        <i class="fas fa-chart-pie"></i>
    </button>

    <div class="ghost-button-wrapper">
        <svg class="map-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 3l-6 2-6-2-5.5 1.83v16.34l5.5-1.83 6 2 6-2 5.5 1.83v-16.34l-5.5-1.83zm-15-1.17l4.5-1.5 6 2 4.5-1.5v15.34l-4.5 1.5-6-2-4.5 1.5v-15.34zM15 4.5v15l4.5-1.5v-15l-4.5 1.5zm-6 15l-4.5 1.5v-15l4.5-1.5v15z"/></svg>
    </div>

    <div class="modal-overlay active" id="introModal">
        <div class="modal-content">
            <h2>üöë Mappa Soccorso Piemonte</h2>
            <p>
                Questa mappa mostra <strong>quanto tempo impiega un‚Äôambulanza</strong> a raggiungere un qualsiasi punto della regione Piemonte.
                <br><br>
                ‚è±Ô∏è Ogni punto colorato indica un'area di 1km¬≤: il colore rappresenta il tempo di arrivo e la dimensione indica la popolazione residente.
                <br><br>
                üë• In questo modo vedi subito sia la velocit√† di accesso, sia dove vive pi√π gente (dove √® pi√π probabile un'emergenza).
                <br><br>
                üöß <strong>Dalla legenda in basso a destra</strong> puoi attivare una visualizzazione che ignora la popolazione e mostra solo le zone raggiungibili, utile per valutare la copertura stradale pura.
            </p>
            <button class="close-btn btn-start" onclick="closeModal('introModal')">Esplora la Mappa</button>
        </div>
    </div>

    <div class="modal-overlay" id="creditsModal">
        <div class="modal-content">
            <h3>‚ÑπÔ∏è Informazioni sul Progetto</h3>
            <div class="credits-list">
                <p><strong>Elaborazione:</strong> Samuele Giatti</p>
                <p><strong>Fonti Dati:</strong></p>
                <ul style="padding-left: 20px; margin-top: 5px; color: #555;">
                    <li><em>Postazioni:</em> Delibere di assegnazione postazioni MSA, MSB ed estemporanee anno 2025 - Azienda Zero.</li>
                    <li><em>Popolazione residente:</em> Griglia Eurostat 2021.</li>
                    <li><em>Calcolo tempi di percorrenza:</em> openrouteservice.</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Hosting Mappa:</strong> CARTO üó∫Ô∏è</p>
            </div>
            <button class="close-btn" onclick="closeModal('creditsModal')">Chiudi</button>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal-content">
            <h3>üìä Copertura Popolazione</h3>
            <p style="text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                Distribuzione della popolazione in base al tempo di arrivo dei soccorsi.
            </p>
            
            <div class="chart-container">
                <canvas id="popChart"></canvas>
            </div>

            <ul class="stats-list">
                <li>
                    <span><span class="dot color-1"></span> 5-10 minuti</span>
                    <strong>2.714.379 ab.</strong>
                </li>
                <li>
                    <span><span class="dot color-2"></span> 10-15 minuti</span>
                    <strong>1.050.306 ab.</strong>
                </li>
                <li>
                    <span><span class="dot color-3"></span> 15-20 minuti</span>
                    <strong>371.732 ab.</strong>
                </li>
                <li>
                    <span><span class="dot color-4"></span> Oltre 20 minuti</span>
                    <strong>124.848 ab.</strong>
                </li>
            </ul>

            <button class="close-btn" onclick="closeModal('statsModal')">Chiudi</button>
        </div>
    </div>

    <script>
        // --- GESTIONE POPUP ---
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // --- CREAZIONE GRAFICO ---
        // Attende che il documento sia caricato
        document.addEventListener("DOMContentLoaded", function() {
            const ctx = document.getElementById('popChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut', // Ciambella (o 'pie' per torta piena)
                data: {
                    labels: ['5-10 min', '10-15 min', '15-20 min', '> 20 min'],
                    datasets: [{
                        data: [2714379, 1050306, 371732, 124848],
                        backgroundColor: [
                            '#CE1256', // Colore 1
                            '#DF65B0', // Colore 2
                            '#D7B5D8', // Colore 3
                            '#F1EEF6'  // Colore 4
                        ],
                        borderColor: [
                            'transparent',
                            'transparent',
                            'transparent',
                            '#cccccc'  // Bordo grigio solo per il colore chiarissimo
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Nascondo la legenda del grafico perch√© c'√® gi√† quella sotto
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    let value = context.raw;
                                    // Calcolo percentuale
                                    let sum = 2714379 + 1050306 + 371732 + 124848;
                                    let percentage = (value * 100 / sum).toFixed(1) + "%";
                                    return label + value.toLocaleString('it-IT') + " (" + percentage + ")";
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>

</body>
</html>